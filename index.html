<script>
// ---------------------------
// GitHub Pages でも Flask でも動く BASE_URL
// ---------------------------
const BASE_PATH = window.location.pathname.startsWith('/tabitomo')
    ? '/tabitomo'
    : '';
const BASE_URL = window.location.origin + BASE_PATH;

console.log("BASE_URL:", BASE_URL);


// ---------------------------
// AudioGuideSystem クラス
// ---------------------------
class AudioGuideSystem {
    constructor() {
        this.totalSpots = 6;
        this.currentSpot = 1;
        this.currentTrack = 1;
        this.spotTrackCounts = {};
        this.isDetecting = false;
        this.isPlaying = false;
        this.isLoading = false;
        this.silenceThreshold = 50;
        this.silenceDuration = 0;
        this.requiredSilenceDuration = 1000;
        this.audioContext = null;
        this.analyser = null;
        this.microphone = null;
        this.audioElement = new Audio();
        this.notificationAudio = new Audio();
        this.isSystemStarted = false;
        this.lastSoundTime = Date.now();
        this.useNotification = true;
        this.useGPS = false;
        this.gpsWatchId = null;
        this.currentPosition = null;
        this.lastSpotChangeByGPS = 0;
        this.gpsRadius = 100;
        this.isFirstGPSFix = true;

        // スポット座標（仮）
        this.spotLocations = [
            { id: 1, lat: 35.6586, lon: 139.7454 },
            { id: 2, lat: 35.6762, lon: 139.6503 },
            { id: 3, lat: 35.7148, lon: 139.7967 },
            { id: 4, lat: 35.6812, lon: 139.7671 },
            { id: 5, lat: 35.6895, lon: 139.6917 },
            { id: 6, lat: 35.60808686673842, lon: 139.55517818459722 },
        ];

        this.initUI();
        this.audioElement.addEventListener("ended", () => this.onAudioEnded());
        this.notificationAudio.addEventListener("ended", () => this.onNotificationEnded());
        this.loadSpotConfiguration();
    }

    // -------------------------
    // 音声ファイルの存在チェック
    // -------------------------
    async loadSpotConfiguration() {
        this.elements.loadingMessage.textContent = "音声ファイルを検索中...";

        for (let spot = 1; spot <= this.totalSpots; spot++) {
            let trackCount = 0;
            let trackIndex = 1;

            while (trackIndex <= 20) {
                const testPath = `${BASE_URL}/static/sounds/spot${spot}/${String(trackIndex).padStart(2, "0")}.wav`;

                const exists = await this.checkFileExists(testPath);
                if (exists) {
                    trackCount = trackIndex;
                    trackIndex++;
                } else {
                    break;
                }
            }

            this.spotTrackCounts[spot] = trackCount;
            console.log(`Spot ${spot}: ${trackCount} tracks found`);
        }

        this.elements.loadingMessage.textContent = `設定完了: 全${this.totalSpots}スポット`;
        this.updateUI();

        setTimeout(() => {
            this.elements.loadingMessage.textContent = "";
        }, 2000);
    }

    async checkFileExists(url) {
        try {
            const response = await fetch(url, { method: "HEAD" });
            return response.ok;
        } catch {
            return false;
        }
    }

    // -------------------------
    // UI 初期化
    // -------------------------
    initUI() {
        this.elements = {
            spotNumber: document.getElementById("spotNumber"),
            trackNumber: document.getElementById("trackNumber"),
            statusText: document.getElementById("statusText"),
            volumeBar: document.getElementById("volumeBar"),
            volumeValue: document.getElementById("volumeValue"),
            thresholdSlider: document.getElementById("thresholdSlider"),
            thresholdValue: document.getElementById("thresholdValue"),
            durationSlider: document.getElementById("durationSlider"),
            durationValue: document.getElementById("durationValue"),
            radiusSlider: document.getElementById("radiusSlider"),
            radiusValue: document.getElementById("radiusValue"),
            thresholdIndicator: document.getElementById("thresholdIndicator"),
            toggleDetection: document.getElementById("toggleDetection"),
            skipButton: document.getElementById("skipButton"),
            startButton: document.getElementById("startButton"),
            loadingMessage: document.getElementById("loadingMessage"),
            notificationToggle: document.getElementById("notificationToggle"),
            gpsToggle: document.getElementById("gpsToggle"),
            gpsStatusRow: document.getElementById("gpsStatusRow"),
            gpsStatus: document.getElementById("gpsStatus"),
            gpsDistance: document.getElementById("gpsDistance"),
        };

        // スライダー等のイベントは元コードのまま
        this.elements.thresholdSlider.addEventListener("input", (e) => {
            this.silenceThreshold = parseInt(e.target.value);
            this.elements.thresholdValue.textContent = this.silenceThreshold;
            this.updateThresholdIndicator();
        });

        this.elements.durationSlider.addEventListener("input", (e) => {
            const seconds = parseFloat(e.target.value);
            this.requiredSilenceDuration = seconds * 1000;
            this.elements.durationValue.textContent = `${seconds.toFixed(1)}秒`;
        });

        this.elements.radiusSlider.addEventListener("input", (e) => {
            this.gpsRadius = parseInt(e.target.value);
            this.elements.radiusValue.textContent = `${this.gpsRadius}m`;
        });

        this.elements.notificationToggle.addEventListener("change", (e) => {
            this.useNotification = e.target.checked;
        });

        this.elements.startButton.addEventListener("click", () => this.startSystem());
        this.elements.toggleDetection.addEventListener("click", () => this.toggleDetection());
        this.elements.skipButton.addEventListener("click", () => this.skipToNextSpot());
    }

    // -------------------------
    // 再生関連
    // -------------------------
    playCurrentTrack() {
        if (this.isPlaying || this.isLoading) return;

        this.isLoading = true;
        this.isPlaying = true;
        this.elements.skipButton.disabled = false;

        if (this.useNotification) {
            this.playNotificationSound();
        } else {
            this.playMainAudio();
        }
    }

    playNotificationSound() {
        const path = `${BASE_URL}/static/sounds/notification.wav`;
        console.log("Notification:", path);

        this.notificationAudio.src = path;
        this.notificationAudio.load();
        this.notificationAudio.play().catch(() => this.playMainAudio());
    }

    onNotificationEnded() {
        this.playMainAudio();
    }

    playMainAudio() {
        const audioPath = `${BASE_URL}/static/sounds/spot${this.currentSpot}/${String(this.currentTrack).padStart(2, "0")}.wav`;

        console.log("Play audio:", audioPath);

        this.updateStatus("読み込み中...");

        this.audioElement.src = audioPath;
        this.audioElement.load();

        this.audioElement.play()
            .then(() => {
                this.isLoading = false;
                this.updateStatus("再生中");
            })
            .catch((err) => {
                console.error("再生エラー:", err);
                this.updateStatus("エラー: 音声が見つかりません");
                this.elements.skipButton.disabled = true;

                setTimeout(() => {
                    this.handlePlaybackError();
                }, 1500);
            });
    }

    onAudioEnded() {
        this.isPlaying = false;
        this.isLoading = false;
        this.elements.skipButton.disabled = true;

        const totalTracks = this.spotTrackCounts[this.currentSpot];
        if (this.currentTrack < totalTracks) {
            this.currentTrack++;
            this.updateUI();
        } else {
            this.moveToNextSpot();
        }
    }

    // -------------------------
    // UI 表示
    // -------------------------
    updateUI() {
        const totalTracks = this.spotTrackCounts[this.currentSpot] || "?";
        this.elements.spotNumber.textContent = this.currentSpot;
        this.elements.trackNumber.textContent = `${this.currentTrack} / ${totalTracks}`;
    }

    updateStatus(msg) {
        this.elements.statusText.textContent = msg;
    }

}
// ---------------------------
// インスタンス生成
// ---------------------------
const guideSystem = new AudioGuideSystem();
</script>
