<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—…ã¨ã‚‚</title>

    <style>
        /* ============================
           å…¨ç«¯æœ«å…±é€šã®ãƒªã‚»ãƒƒãƒˆ & ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç¦æ­¢
        ============================ */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;       /* â† ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç¦æ­¢ */
            touch-action: none;     /* â† ã‚¹ãƒãƒ›ã®ã‚¹ãƒ¯ã‚¤ãƒ—æºã‚Œé˜²æ­¢ */
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100dvh;     /* â† ã‚¹ãƒãƒ›ã®è¡¨ç¤ºé ˜åŸŸã«å¯¾å¿œ */
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* ============================
           ãƒ¡ã‚¤ãƒ³ã‚«ãƒ¼ãƒ‰UI
        ============================ */
        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
            font-size: 24px;
        }

        /* ============================
           çŠ¶æ…‹è¡¨ç¤º
        ============================ */
        .status-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .status-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .status-label { color: #6c757d; font-weight: 600; }
        .status-value { color: #212529; font-weight: 700; }

        .gps-distance {
            background: #e7f5ff;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            margin-top: 10px;
            font-size: 16px;
            font-weight: 700;
            color: #0c5460;
            display: none;
        }

        /* ============================
           éŸ³é‡ãƒãƒ¼
        ============================ */
        .volume-bar-container { margin-bottom: 25px; }
        .volume-bar-label {
            font-size: 14px;
            color: #6c757d;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .volume-bar-wrapper {
            background: #e9ecef;
            height: 30px;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .volume-bar {
            height: 100%;
            background: linear-gradient(90deg, #28a745 0%, #ffc107 50%, #dc3545 100%);
            width: 0%;
            transition: width 0.1s ease-out;
        }

        .threshold-indicator {
            position: absolute;
            top: 0; bottom: 0;
            width: 3px;
            background: #dc3545;
            z-index: 10;
            transition: left 0.3s ease;
        }

        .volume-value {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            font-weight: 700;
            color: #495057;
        }

        /* ============================
           ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼
        ============================ */
        .control-section {
            margin-bottom: 15px;
        }

        .control-label {
            font-size: 14px;
            color: #6c757d;
            margin-bottom: 10px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        input[type="range"] {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 5px;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            width: 20px; height: 20px;
            background: #667eea;
            border-radius: 50%;
            cursor: pointer;
            -webkit-appearance: none;
        }

        /* ============================
           ãƒœã‚¿ãƒ³
        ============================ */
        button {
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 20px;
        }

        .btn-primary { background: #667eea; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-success { background: #28a745; color: white; grid-column: 1 / -1; }

        .notification-toggle,
        .gps-toggle {
            grid-column: 1 / -1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        /* ============================
           ã‚¹ãƒãƒ›æœ€é©åŒ–
        ============================ */
        @media screen and (max-width: 480px) {

            body { padding: 12px; }

            .container {
                padding: 18px;
                border-radius: 16px;
            }

            h1 {
                font-size: 22px;
                margin-bottom: 18px;
            }

            .volume-bar-wrapper {
                height: 38px;
            }

            input[type="range"]::-webkit-slider-thumb {
                width: 30px; height: 30px;
            }

            button {
                padding: 14px;
                font-size: 15px;
                border-radius: 12px;
            }

            .button-group {
                gap: 14px;
            }
        }
    </style>
</head>

<body>

    <div class="container">
        <h1>ğŸ§ æ—…ã¨ã‚‚</h1>

        <div class="status-section">
            <div class="status-row">
                <span class="status-label">ã‚¹ãƒãƒƒãƒˆ:</span>
                <span class="status-value" id="spotNumber">1</span>
            </div>
            <div class="status-row">
                <span class="status-label">ãƒˆãƒ©ãƒƒã‚¯:</span>
                <span class="status-value" id="trackNumber">1 / ?</span>
            </div>
            <div class="status-row">
                <span class="status-label">çŠ¶æ…‹:</span>
                <span class="status-value" id="statusText">åˆæœŸåŒ–ä¸­...</span>
            </div>

            <div class="status-row" id="gpsStatusRow" style="display:none;">
                <span class="status-label">GPS:</span>
                <span class="status-value gps-status" id="gpsStatus">å–å¾—ä¸­...</span>
            </div>

            <div class="gps-distance" id="gpsDistance">ğŸ“ æ¬¡ã®ã‚¹ãƒãƒƒãƒˆã¾ã§: è¨ˆç®—ä¸­...</div>
        </div>

        <div class="volume-bar-container">
            <div class="volume-bar-label">éŸ³é‡ãƒ¬ãƒ™ãƒ«</div>
            <div class="volume-bar-wrapper">
                <div class="volume-bar" id="volumeBar"></div>
                <div class="threshold-indicator" id="thresholdIndicator"></div>
                <span class="volume-value" id="volumeValue">0</span>
            </div>
        </div>

        <div class="control-section">
            <div class="control-label">
                <span>ç„¡éŸ³æ¤œçŸ¥ã—ãã„å€¤</span>
                <span id="thresholdValue" class="threshold-value">50</span>
            </div>
            <input type="range" id="thresholdSlider" min="0" max="100" value="50">
        </div>

        <div class="control-section">
            <div class="control-label">
                <span>ç„¡éŸ³æŒç¶šæ™‚é–“</span>
                <span id="durationValue" class="duration-value">1ç§’</span>
            </div>
            <input type="range" id="durationSlider" min="0.5" max="30" value="1" step="0.5">
        </div>

        <div class="control-section">
            <div class="control-label">
                <span>GPSæ¤œçŸ¥ç¯„å›²</span>
                <span id="radiusValue" class="radius-value">100m</span>
            </div>
            <input type="range" id="radiusSlider" min="50" max="1000" value="100" step="50">
        </div>

        <div class="button-group">
            <div class="gps-toggle">
                <input type="checkbox" id="gpsToggle">
                <label for="gpsToggle">ğŸ“ GPSè‡ªå‹•åˆ‡ã‚Šæ›¿ãˆ</label>
            </div>

            <div class="notification-toggle">
                <input type="checkbox" id="notificationToggle" checked>
                <label for="notificationToggle">ğŸ”” é€šçŸ¥éŸ³ã‚’é³´ã‚‰ã™</label>
            </div>

            <button class="btn-primary" id="toggleDetection" disabled>æ¤œçŸ¥é–‹å§‹</button>
            <button class="btn-secondary" id="skipButton" disabled>æ¬¡ã¸ã‚¹ã‚­ãƒƒãƒ—</button>
            <button class="btn-success" id="startButton">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        </div>

        <div class="loading" id="loadingMessage"></div>
    </div>

</body>
</html>

// ===============================
// GitHub Pages å¯¾å¿œ BASE_URL è¨­å®š
// ===============================
const BASE_PATH = window.location.pathname.startsWith("/tabitomo")
    ? "/tabitomo"
    : "";
const BASE_URL = window.location.origin + BASE_PATH;

class AudioGuideSystem {
    constructor() {
        this.totalSpots = 6;
        this.currentSpot = 1;
        this.currentTrack = 1;
        this.spotTrackCounts = {};
        this.isDetecting = false;
        this.isPlaying = false;
        this.isLoading = false;
        this.silenceThreshold = 50;
        this.silenceDuration = 0;
        this.requiredSilenceDuration = 1000;
        this.audioContext = null;
        this.analyser = null;
        this.microphone = null;
        this.audioElement = new Audio();
        this.notificationAudio = new Audio();
        this.isSystemStarted = false;
        this.lastSoundTime = Date.now();
        this.useNotification = true;
        this.useGPS = false;
        this.gpsWatchId = null;
        this.currentPosition = null;
        this.lastSpotChangeByGPS = 0;
        this.gpsRadius = 100;
        this.isFirstGPSFix = true;

        this.initUI();
        this.audioElement.addEventListener("ended", () => this.onAudioEnded());
        this.notificationAudio.addEventListener("ended", () => this.onNotificationEnded());
        this.loadSpotConfiguration();
    }

    // ===========================
    //  éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«è‡ªå‹•ã‚¹ã‚­ãƒ£ãƒ³
    // ===========================
    async loadSpotConfiguration() {
        this.elements.loadingMessage.textContent = "éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢ä¸­...";

        for (let spot = 1; spot <= this.totalSpots; spot++) {
            let trackCount = 0;
            let trackIndex = 1;

            while (trackIndex <= 20) {
                const testPath = `${BASE_URL}/static/sounds/spot${spot}/${String(
                    trackIndex
                ).padStart(2, "0")}.wav`;

                const exists = await this.checkFileExists(testPath);
                if (exists) {
                    trackCount = trackIndex;
                    trackIndex++;
                } else {
                    break;
                }
            }

            this.spotTrackCounts[spot] = trackCount;
            console.log(`Spot ${spot}: ${trackCount} tracks found`);
        }

        this.updateUI();

        this.elements.loadingMessage.textContent = `è¨­å®šå®Œäº†: å…¨${this.totalSpots}ã‚¹ãƒãƒƒãƒˆ`;
        setTimeout(() => {
            this.elements.loadingMessage.textContent = "";
        }, 2000);
    }

    async checkFileExists(url) {
        try {
            const res = await fetch(url, { method: "HEAD" });
            return res.ok;
        } catch (e) {
            return false;
        }
    }

    // ===========================
    //      UI åˆæœŸåŒ–
    // ===========================
    initUI() {
        this.elements = {
            spotNumber: document.getElementById("spotNumber"),
            trackNumber: document.getElementById("trackNumber"),
            statusText: document.getElementById("statusText"),
            volumeBar: document.getElementById("volumeBar"),
            volumeValue: document.getElementById("volumeValue"),
            thresholdSlider: document.getElementById("thresholdSlider"),
            thresholdValue: document.getElementById("thresholdValue"),
            durationSlider: document.getElementById("durationSlider"),
            durationValue: document.getElementById("durationValue"),
            radiusSlider: document.getElementById("radiusSlider"),
            radiusValue: document.getElementById("radiusValue"),
            thresholdIndicator: document.getElementById("thresholdIndicator"),
            toggleDetection: document.getElementById("toggleDetection"),
            skipButton: document.getElementById("skipButton"),
            startButton: document.getElementById("startButton"),
            loadingMessage: document.getElementById("loadingMessage"),
            notificationToggle: document.getElementById("notificationToggle"),
            gpsToggle: document.getElementById("gpsToggle"),
        };

        this.elements.thresholdSlider.addEventListener("input", (e) => {
            this.silenceThreshold = parseInt(e.target.value);
            this.elements.thresholdValue.textContent = this.silenceThreshold;
            this.updateThresholdIndicator();
        });

        this.elements.durationSlider.addEventListener("input", (e) => {
            const sec = parseFloat(e.target.value);
            this.requiredSilenceDuration = sec * 1000;
            this.elements.durationValue.textContent = `${sec.toFixed(1)}ç§’`;
        });

        this.elements.toggleDetection.addEventListener("click", () =>
            this.toggleDetection()
        );

        this.elements.startButton.addEventListener("click", () => this.startSystem());
        this.elements.skipButton.addEventListener("click", () => this.skipToNextSpot());
        this.elements.notificationToggle.addEventListener(
            "change",
            (e) => (this.useNotification = e.target.checked)
        );
    }

    // ===========================
    //   ãƒã‚¤ã‚¯èµ·å‹• & æ¤œçŸ¥
    // ===========================
    async startSystem() {
        if (this.isSystemStarted) return;

        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

            this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
            this.analyser = this.audioContext.createAnalyser();
            this.analyser.fftSize = 2048;

            this.microphone = this.audioContext.createMediaStreamSource(stream);
            this.microphone.connect(this.analyser);

            this.isSystemStarted = true;

            this.elements.startButton.disabled = true;
            this.elements.toggleDetection.disabled = false;

            this.updateStatus("å¾…æ©Ÿä¸­");

            this.startVolumeMonitoring();
            this.updateThresholdIndicator();

            this.toggleDetection();
        } catch (err) {
            alert("ãƒã‚¤ã‚¯ã®ä½¿ç”¨ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸï¼");
        }
    }

    startVolumeMonitoring() {
        const update = () => {
            if (!this.analyser) return;

            const bufferLength = this.analyser.frequencyBinCount;
            const data = new Uint8Array(bufferLength);
            this.analyser.getByteFrequencyData(data);

            const avg = data.reduce((a, b) => a + b, 0) / data.length;
            const volume = Math.min(100, Math.max(0, (avg / 255) * 100));

            this.elements.volumeBar.style.width = volume + "%";
            this.elements.volumeValue.textContent = Math.round(volume);

            if (this.isDetecting && !this.isPlaying && !this.isLoading) {
                const now = Date.now();
                if (volume > this.silenceThreshold) {
                    this.lastSoundTime = now;
                } else {
                    if (now - this.lastSoundTime >= this.requiredSilenceDuration) {
                        this.onSilenceDetected();
                    }
                }
            }

            requestAnimationFrame(update);
        };

        update();
    }

    updateThresholdIndicator() {
        this.elements.thresholdIndicator.style.left = this.silenceThreshold + "%";
    }

    toggleDetection() {
        this.isDetecting = !this.isDetecting;

        if (this.isDetecting) {
            this.elements.toggleDetection.textContent = "æ¤œçŸ¥åœæ­¢";
            this.updateStatus("æ¤œçŸ¥ä¸­");
            this.lastSoundTime = Date.now();
        } else {
            this.elements.toggleDetection.textContent = "æ¤œçŸ¥é–‹å§‹";
            this.updateStatus("æ¤œçŸ¥åœæ­¢");
        }
    }

    // ===========================
    //  ç„¡éŸ³ â†’ éŸ³å£°å†ç”Ÿ
    // ===========================
    onSilenceDetected() {
        if (this.isPlaying || this.isLoading) return;

        const total = this.spotTrackCounts[this.currentSpot] || 0;

        if (this.currentTrack <= total) {
            this.playCurrentTrack();
        } else {
            this.moveToNextSpot();
        }
    }

    playCurrentTrack() {
        this.isLoading = true;
        this.isPlaying = true;
        this.elements.skipButton.disabled = false;

        if (this.useNotification) {
            this.notificationAudio.src = `${BASE_URL}/static/sounds/notification.wav`;
            this.notificationAudio.play().catch(() => this.playMainAudio());
        } else {
            this.playMainAudio();
        }
    }

    onNotificationEnded() {
        this.playMainAudio();
    }

    playMainAudio() {
        const url = `${BASE_URL}/static/sounds/spot${this.currentSpot}/${String(
            this.currentTrack
        ).padStart(2, "0")}.wav`;

        this.updateStatus("èª­ã¿è¾¼ã¿ä¸­...");
        this.audioElement.src = url;
        this.audioElement.load();

        this.audioElement
            .play()
            .then(() => {
                this.updateStatus("å†ç”Ÿä¸­");
                this.isLoading = false;
            })
            .catch(() => {
                this.updateStatus("ã‚¨ãƒ©ãƒ¼: éŸ³å£°ãªã—");
                this.isPlaying = false;
                this.isLoading = false;
                this.skipToNextSpot();
            });
    }

    onAudioEnded() {
        this.isPlaying = false;
        this.currentTrack++;

        const total = this.spotTrackCounts[this.currentSpot];

        if (this.currentTrack <= total) {
            this.updateUI();
            this.updateStatus("æ¤œçŸ¥ä¸­(æ¬¡ã®ãƒˆãƒ©ãƒƒã‚¯)");
        } else {
            this.moveToNextSpot();
        }
    }

    moveToNextSpot() {
        this.currentSpot++;
        if (this.currentSpot > this.totalSpots) this.currentSpot = 1;

        this.currentTrack = 1;
        this.updateUI();
        this.updateStatus("æ¤œçŸ¥ä¸­(æ¬¡ã®ã‚¹ãƒãƒƒãƒˆ)");
        this.elements.skipButton.disabled = true;
    }

    skipToNextSpot() {
        if (this.isPlaying) {
            this.audioElement.pause();
            this.audioElement.currentTime = 0;
        }
        this.moveToNextSpot();
    }

    // ===========================
    //        UI æ›´æ–°
    // ===========================
    updateUI() {
        const total = this.spotTrackCounts[this.currentSpot] || "?";
        this.elements.spotNumber.textContent = this.currentSpot;
        this.elements.trackNumber.textContent = `${this.currentTrack} / ${total}`;
    }

    updateStatus(msg) {
        this.elements.statusText.textContent = msg;
    }
}

// =========================
//   å®Ÿè¡Œ
// =========================
const guideSystem = new AudioGuideSystem();

</script>

</body>
</html>