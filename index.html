<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÊóÖ„Å®„ÇÇ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
            font-size: 24px;
        }

        .status-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .status-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .status-row:last-child {
            margin-bottom: 0;
        }

        .status-label {
            color: #6c757d;
            font-weight: 600;
        }

        .status-value {
            color: #212529;
            font-weight: 700;
        }

        .status-active {
            color: #28a745;
        }

        .status-playing {
            color: #007bff;
        }

        .gps-status {
            color: #17a2b8;
        }

        .gps-distance {
            background: #e7f5ff;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            margin-top: 10px;
            font-size: 16px;
            font-weight: 700;
            color: #0c5460;
        }

        .volume-bar-container {
            margin-bottom: 25px;
        }

        .volume-bar-label {
            font-size: 14px;
            color: #6c757d;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .volume-bar-wrapper {
            background: #e9ecef;
            height: 30px;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .volume-bar {
            height: 100%;
            background: linear-gradient(90deg, #28a745 0%, #ffc107 50%, #dc3545 100%);
            width: 0%;
            transition: width 0.1s ease-out;
        }

        .threshold-indicator {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 3px;
            background: #dc3545;
            z-index: 10;
            transition: left 0.3s ease;
        }

        .threshold-indicator::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 10px;
            height: 10px;
            background: #dc3545;
            border-radius: 50%;
            border: 2px solid white;
        }

        .volume-value {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            font-weight: 700;
            color: #495057;
            z-index: 5;
        }

        .control-section {
            margin-bottom: 15px;
        }

        .control-label {
            font-size: 14px;
            color: #6c757d;
            margin-bottom: 10px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .threshold-value {
            color: #667eea;
            font-weight: 700;
        }

        .duration-value {
            color: #764ba2;
            font-weight: 700;
        }

        .radius-value {
            color: #17a2b8;
            font-weight: 700;
        }

        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #e9ecef;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }

        .notification-toggle, .gps-toggle {
            grid-column: 1 / -1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .notification-toggle input[type="checkbox"],
        .gps-toggle input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .notification-toggle label,
        .gps-toggle label {
            font-size: 14px;
            font-weight: 600;
            color: #495057;
            cursor: pointer;
        }

        button {
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.4);
        }

        .btn-success {
            background: #28a745;
            color: white;
            grid-column: 1 / -1;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.6;
            }
        }

        .loading {
            text-align: center;
            color: #667eea;
            font-size: 14px;
            margin-top: 10px;
        }

        @media (max-width: 480px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 20px;
                margin-bottom: 20px;
            }

            button {
                padding: 12px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéß ÊóÖ„Å®„ÇÇ</h1>
        
        <div class="status-section">
            <div class="status-row">
                <span class="status-label">„Çπ„Éù„ÉÉ„Éà:</span>
                <span class="status-value" id="spotNumber">1</span>
            </div>
            <div class="status-row">
                <span class="status-label">„Éà„É©„ÉÉ„ÇØ:</span>
                <span class="status-value" id="trackNumber">1 / ?</span>
            </div>
            <div class="status-row">
                <span class="status-label">Áä∂ÊÖã:</span>
                <span class="status-value" id="statusText">ÂàùÊúüÂåñ‰∏≠...</span>
            </div>
            <div class="status-row" id="gpsStatusRow" style="display: none;">
                <span class="status-label">GPS:</span>
                <span class="status-value gps-status" id="gpsStatus">ÂèñÂæó‰∏≠...</span>
            </div>
            <div class="gps-distance" id="gpsDistance" style="display: none;">
                üìç Ê¨°„ÅÆ„Çπ„Éù„ÉÉ„Éà„Åæ„Åß: Ë®àÁÆó‰∏≠...
            </div>
        </div>

        <div class="volume-bar-container">
            <div class="volume-bar-label">Èü≥Èáè„É¨„Éô„É´</div>
            <div class="volume-bar-wrapper">
                <div class="volume-bar" id="volumeBar"></div>
                <div class="threshold-indicator" id="thresholdIndicator"></div>
                <span class="volume-value" id="volumeValue">0</span>
            </div>
        </div>

        <div class="control-section">
            <div class="control-label">
                <span>ÁÑ°Èü≥Ê§úÁü•„Åó„Åç„ÅÑÂÄ§</span>
                <span class="threshold-value" id="thresholdValue">50</span>
            </div>
            <input type="range" id="thresholdSlider" min="0" max="100" value="50" step="1">
        </div>

        <div class="control-section">
            <div class="control-label">
                <span>ÁÑ°Èü≥ÊåÅÁ∂öÊôÇÈñì</span>
                <span class="duration-value" id="durationValue">1.0Áßí</span>
            </div>
            <input type="range" id="durationSlider" min="0.5" max="30.0" value="1.0" step="0.5">
        </div>

        <div class="control-section">
            <div class="control-label">
                <span>GPSÊ§úÁü•ÁØÑÂõ≤</span>
                <span class="radius-value" id="radiusValue">100m</span>
            </div>
            <input type="range" id="radiusSlider" min="50" max="1000" value="100" step="50">
        </div>

        <div class="button-group">
            <div class="gps-toggle">
                <input type="checkbox" id="gpsToggle">
                <label for="gpsToggle">üìç GPSËá™ÂãïÂàá„ÇäÊõø„Åà</label>
            </div>
            <div class="notification-toggle">
                <input type="checkbox" id="notificationToggle" checked>
                <label for="notificationToggle">üîî ÈÄöÁü•Èü≥„ÇíÈ≥¥„Çâ„Åô</label>
            </div>
            <button class="btn-primary" id="toggleDetection" disabled>Ê§úÁü•ÈñãÂßã</button>
            <button class="btn-secondary" id="skipButton" disabled>Ê¨°„Å∏„Çπ„Ç≠„ÉÉ„Éó</button>
            <button class="btn-success" id="startButton">„Çπ„Çø„Éº„Éà</button>
        </div>
        
        <div class="loading" id="loadingMessage"></div>
    </div>

 <script>
// ---------------------------
// GitHub Pages „Åß„ÇÇ Flask „Åß„ÇÇÂãï„Åè BASE_URL
// ---------------------------
const BASE_PATH = window.location.pathname.startsWith('/tabitomo')
    ? '/tabitomo'
    : '';
const BASE_URL = window.location.origin + BASE_PATH;

console.log("BASE_URL:", BASE_URL);


// ---------------------------
// AudioGuideSystem „ÇØ„É©„Çπ
// ---------------------------
class AudioGuideSystem {
    constructor() {
        this.totalSpots = 6;
        this.currentSpot = 1;
        this.currentTrack = 1;
        this.spotTrackCounts = {};
        this.isDetecting = false;
        this.isPlaying = false;
        this.isLoading = false;
        this.silenceThreshold = 50;
        this.silenceDuration = 0;
        this.requiredSilenceDuration = 1000;
        this.audioContext = null;
        this.analyser = null;
        this.microphone = null;
        this.audioElement = new Audio();
        this.notificationAudio = new Audio();
        this.isSystemStarted = false;
        this.lastSoundTime = Date.now();
        this.useNotification = true;
        this.useGPS = false;
        this.gpsWatchId = null;
        this.currentPosition = null;
        this.lastSpotChangeByGPS = 0;
        this.gpsRadius = 100;
        this.isFirstGPSFix = true;

        // „Çπ„Éù„ÉÉ„ÉàÂ∫ßÊ®ôÔºà‰ªÆÔºâ
        this.spotLocations = [
            { id: 1, lat: 35.6586, lon: 139.7454 },
            { id: 2, lat: 35.6762, lon: 139.6503 },
            { id: 3, lat: 35.7148, lon: 139.7967 },
            { id: 4, lat: 35.6812, lon: 139.7671 },
            { id: 5, lat: 35.6895, lon: 139.6917 },
            { id: 6, lat: 35.60808686673842, lon: 139.55517818459722 },
        ];

        this.initUI();
        this.audioElement.addEventListener("ended", () => this.onAudioEnded());
        this.notificationAudio.addEventListener("ended", () => this.onNotificationEnded());
        this.loadSpotConfiguration();
    }

    // -------------------------
    // Èü≥Â£∞„Éï„Ç°„Ç§„É´„ÅÆÂ≠òÂú®„ÉÅ„Çß„ÉÉ„ÇØ
    // -------------------------
    async loadSpotConfiguration() {
        this.elements.loadingMessage.textContent = "Èü≥Â£∞„Éï„Ç°„Ç§„É´„ÇíÊ§úÁ¥¢‰∏≠...";

        for (let spot = 1; spot <= this.totalSpots; spot++) {
            let trackCount = 0;
            let trackIndex = 1;

            while (trackIndex <= 20) {
                const testPath = `${BASE_URL}/static/sounds/spot${spot}/${String(trackIndex).padStart(2, "0")}.wav`;

                const exists = await this.checkFileExists(testPath);
                if (exists) {
                    trackCount = trackIndex;
                    trackIndex++;
                } else {
                    break;
                }
            }

            this.spotTrackCounts[spot] = trackCount;
            console.log(`Spot ${spot}: ${trackCount} tracks found`);
        }

        this.elements.loadingMessage.textContent = `Ë®≠ÂÆöÂÆå‰∫Ü: ÂÖ®${this.totalSpots}„Çπ„Éù„ÉÉ„Éà`;
        this.updateUI();

        setTimeout(() => {
            this.elements.loadingMessage.textContent = "";
        }, 2000);
    }

    async checkFileExists(url) {
        try {
            const response = await fetch(url, { method: "HEAD" });
            return response.ok;
        } catch {
            return false;
        }
    }

    // -------------------------
    // UI ÂàùÊúüÂåñ
    // -------------------------
    initUI() {
        this.elements = {
            spotNumber: document.getElementById("spotNumber"),
            trackNumber: document.getElementById("trackNumber"),
            statusText: document.getElementById("statusText"),
            volumeBar: document.getElementById("volumeBar"),
            volumeValue: document.getElementById("volumeValue"),
            thresholdSlider: document.getElementById("thresholdSlider"),
            thresholdValue: document.getElementById("thresholdValue"),
            durationSlider: document.getElementById("durationSlider"),
            durationValue: document.getElementById("durationValue"),
            radiusSlider: document.getElementById("radiusSlider"),
            radiusValue: document.getElementById("radiusValue"),
            thresholdIndicator: document.getElementById("thresholdIndicator"),
            toggleDetection: document.getElementById("toggleDetection"),
            skipButton: document.getElementById("skipButton"),
            startButton: document.getElementById("startButton"),
            loadingMessage: document.getElementById("loadingMessage"),
            notificationToggle: document.getElementById("notificationToggle"),
            gpsToggle: document.getElementById("gpsToggle"),
            gpsStatusRow: document.getElementById("gpsStatusRow"),
            gpsStatus: document.getElementById("gpsStatus"),
            gpsDistance: document.getElementById("gpsDistance"),
        };

        // „Çπ„É©„Ç§„ÉÄ„ÉºÁ≠â„ÅÆ„Ç§„Éô„É≥„Éà„ÅØÂÖÉ„Ç≥„Éº„Éâ„ÅÆ„Åæ„Åæ
        this.elements.thresholdSlider.addEventListener("input", (e) => {
            this.silenceThreshold = parseInt(e.target.value);
            this.elements.thresholdValue.textContent = this.silenceThreshold;
            this.updateThresholdIndicator();
        });

        this.elements.durationSlider.addEventListener("input", (e) => {
            const seconds = parseFloat(e.target.value);
            this.requiredSilenceDuration = seconds * 1000;
            this.elements.durationValue.textContent = `${seconds.toFixed(1)}Áßí`;
        });

        this.elements.radiusSlider.addEventListener("input", (e) => {
            this.gpsRadius = parseInt(e.target.value);
            this.elements.radiusValue.textContent = `${this.gpsRadius}m`;
        });

        this.elements.notificationToggle.addEventListener("change", (e) => {
            this.useNotification = e.target.checked;
        });

        this.elements.startButton.addEventListener("click", () => this.startSystem());
        this.elements.toggleDetection.addEventListener("click", () => this.toggleDetection());
        this.elements.skipButton.addEventListener("click", () => this.skipToNextSpot());
    }

    // -------------------------
    // ÂÜçÁîüÈñ¢ÈÄ£
    // -------------------------
    playCurrentTrack() {
        if (this.isPlaying || this.isLoading) return;

        this.isLoading = true;
        this.isPlaying = true;
        this.elements.skipButton.disabled = false;

        if (this.useNotification) {
            this.playNotificationSound();
        } else {
            this.playMainAudio();
        }
    }

    playNotificationSound() {
        const path = `${BASE_URL}/static/sounds/notification.wav`;
        console.log("Notification:", path);

        this.notificationAudio.src = path;
        this.notificationAudio.load();
        this.notificationAudio.play().catch(() => this.playMainAudio());
    }

    onNotificationEnded() {
        this.playMainAudio();
    }

    playMainAudio() {
        const audioPath = `${BASE_URL}/static/sounds/spot${this.currentSpot}/${String(this.currentTrack).padStart(2, "0")}.wav`;

        console.log("Play audio:", audioPath);

        this.updateStatus("Ë™≠„ÅøËæº„Åø‰∏≠...");

        this.audioElement.src = audioPath;
        this.audioElement.load();

        this.audioElement.play()
            .then(() => {
                this.isLoading = false;
                this.updateStatus("ÂÜçÁîü‰∏≠");
            })
            .catch((err) => {
                console.error("ÂÜçÁîü„Ç®„É©„Éº:", err);
                this.updateStatus("„Ç®„É©„Éº: Èü≥Â£∞„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì");
                this.elements.skipButton.disabled = true;

                setTimeout(() => {
                    this.handlePlaybackError();
                }, 1500);
            });
    }

    onAudioEnded() {
        this.isPlaying = false;
        this.isLoading = false;
        this.elements.skipButton.disabled = true;

        const totalTracks = this.spotTrackCounts[this.currentSpot];
        if (this.currentTrack < totalTracks) {
            this.currentTrack++;
            this.updateUI();
        } else {
            this.moveToNextSpot();
        }
    }

    // -------------------------
    // UI Ë°®Á§∫
    // -------------------------
    updateUI() {
        const totalTracks = this.spotTrackCounts[this.currentSpot] || "?";
        this.elements.spotNumber.textContent = this.currentSpot;
        this.elements.trackNumber.textContent = `${this.currentTrack} / ${totalTracks}`;
    }

    updateStatus(msg) {
        this.elements.statusText.textContent = msg;
    }

}
// ---------------------------
// „Ç§„É≥„Çπ„Çø„É≥„ÇπÁîüÊàê
// ---------------------------
const guideSystem = new AudioGuideSystem();
</script>

</body>
</html>