this.playMainAudio();
                }
            }

            onNotificationEnded() {
                this.playMainAudio();
            }

            playMainAudio() {
                const audioPath = `/static/sounds/spot${this.currentSpot}/${String(this.currentTrack).padStart(2, '0')}.wav`;
                
                this.updateStatus('読み込み中...');
                
                this.audioElement.src = audioPath;
                this.audioElement.load();
                
                this.audioElement.play()
                    .then(() => {
                        this.isLoading = false;
                        this.updateStatus('再生中');
                        console.log(`Playing: ${audioPath}`);
                    })
                    .catch(error => {
                        console.error('Audio play error:', error);
                        console.error('Failed to load:', audioPath);
                        this.isLoading = false;
                        this.isPlaying = false;
                        this.updateStatus('エラー: 音声ファイルが見つかりません');
                        this.elements.skipButton.disabled = true;
                        
                        setTimeout(() => {
                            this.handlePlaybackError();
                        }, 2000);
                    });
            }

            handlePlaybackError() {
                const totalTracks = this.spotTrackCounts[this.currentSpot] || 0;
                
                if (this.currentTrack < totalTracks) {
                    this.currentTrack++;
                    this.updateUI();
                    this.silenceDuration = 0;
                    this.lastSoundTime = Date.now();
                    if (this.isDetecting) {
                        this.updateStatus('検知中 (エラー後)');
                    }
                } else {
                    this.moveToNextSpot();
                }
            }

            onAudioEnded() {
                this.isPlaying = false;
                this.isLoading = false;
                this.lastSoundTime = Date.now();
                this.silenceDuration = 0;
                this.elements.skipButton.disabled = true;
                
                const totalTracks = this.spotTrackCounts[this.currentSpot] || 0;
                
                if (this.currentTrack < totalTracks) {
                    this.currentTrack++;
                    this.updateUI();
                    
                    if (this.isDetecting) {
                        this.updateStatus('検知中 (次のトラック待機)');
                    } else {
                        this.updateStatus('待機中');
                    }
                } else {
                    this.completedSpots.add(this.currentSpot);
                    this.updateCompletedCount();
                    
                    console.log(`Spot ${this.currentSpot} completed`);
                    
                    if (!this.useGPS) {
                        this.moveToNextSpot();
                    } else {
                        this.currentTrack = 1;
                        this.updateUI();
                        if (this.isDetecting) {
                            this.updateStatus('検知中 (スポット完了)');
                        } else {
                            this.updateStatus('スポット完了');
                        }
                    }
                }
            }

            moveToNextSpot() {
                this.currentSpot++;
                this.currentTrack = 1;
                
                if (this.currentSpot > this.totalSpots) {
                    this.speakFinalMessage();
                    this.currentSpot = 1;
                }
                
                this.updateUI();
                
                if (this.isDetecting) {
                    this.updateStatus('検知中 (次のスポット)');
                } else {
                    this.updateStatus('待機中');
                }
                
                this.elements.skipButton.disabled = true;
            }

            skipToNextSpot() {
                if (this.isPlaying) {
                    this.audioElement.pause();
                    this.audioElement.currentTime = 0;
                }
                
                this.isPlaying = false;
                this.isLoading = false;
                this.moveToNextSpot();
            }

            speakFinalMessage() {
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance('ありがとうございました。ツアーは終了です。');
                    utterance.lang = 'ja-JP';
                    utterance.rate = 1.0;
                    window.speechSynthesis.speak(utterance);
                }
            }

            updateUI() {
                const totalTracks = this.spotTrackCounts[this.currentSpot] || '?';
                this.elements.spotNumber.textContent = this.currentSpot;
                this.elements.trackNumber.textContent = `${this.currentTrack} / ${totalTracks}`;
            }

            updateCompletedCount() {
                this.elements.completedCount.textContent = `${this.completedSpots.size} / ${this.totalSpots}`;
            }

            updateStatus(status) {
                this.elements.statusText.textContent = status;
                this.elements.statusText.className = 'status-value';
                
                if (status.includes('検知中')) {
                    this.elements.statusText.classList.add('status-active', 'pulse');
                } else if (status.includes('再生中')) {
                    this.elements.statusText.classList.add('status-playing');
                } else {
                    this.elements.statusText.classList.remove('pulse');
                }
            }
        }

        const guideSystem = new AudioGuideSystem();
    </script>
</body>
</html>