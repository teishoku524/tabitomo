<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÊóÖ„Å®„ÇÇ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
            font-size: 24px;
        }

        .status-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .status-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .status-row:last-child {
            margin-bottom: 0;
        }

        .status-label {
            color: #6c757d;
            font-weight: 600;
        }

        .status-value {
            color: #212529;
            font-weight: 700;
        }

        .status-active {
            color: #28a745;
        }

        .status-playing {
            color: #007bff;
        }

        .gps-status {
            color: #17a2b8;
        }

        .gps-distance {
            background: #e7f5ff;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            margin-top: 10px;
            font-size: 16px;
            font-weight: 700;
            color: #0c5460;
        }

        .volume-bar-container {
            margin-bottom: 25px;
        }

        .volume-bar-label {
            font-size: 14px;
            color: #6c757d;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .volume-bar-wrapper {
            background: #e9ecef;
            height: 30px;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .volume-bar {
            height: 100%;
            background: linear-gradient(90deg, #28a745 0%, #ffc107 50%, #dc3545 100%);
            width: 0%;
            transition: width 0.1s ease-out;
        }

        .threshold-indicator {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 3px;
            background: #dc3545;
            z-index: 10;
            transition: left 0.3s ease;
        }

        .threshold-indicator::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 10px;
            height: 10px;
            background: #dc3545;
            border-radius: 50%;
            border: 2px solid white;
        }

        .volume-value {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            font-weight: 700;
            color: #495057;
            z-index: 5;
        }

        .control-section {
            margin-bottom: 15px;
        }

        .control-label {
            font-size: 14px;
            color: #6c757d;
            margin-bottom: 10px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .threshold-value {
            color: #667eea;
            font-weight: 700;
        }

        .duration-value {
            color: #764ba2;
            font-weight: 700;
        }

        .radius-value {
            color: #17a2b8;
            font-weight: 700;
        }

        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #e9ecef;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }

        .notification-toggle, .gps-toggle {
            grid-column: 1 / -1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .notification-toggle input[type="checkbox"],
        .gps-toggle input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .notification-toggle label,
        .gps-toggle label {
            font-size: 14px;
            font-weight: 600;
            color: #495057;
            cursor: pointer;
        }

        button {
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.4);
        }

        .btn-success {
            background: #28a745;
            color: white;
            grid-column: 1 / -1;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.6;
            }
        }

        .loading {
            text-align: center;
            color: #667eea;
            font-size: 14px;
            margin-top: 10px;
        }

        @media (max-width: 480px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 20px;
                margin-bottom: 20px;
            }

            button {
                padding: 12px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéß ÊóÖ„Å®„ÇÇ</h1>
        
        <div class="status-section">
            <div class="status-row">
                <span class="status-label">„Çπ„Éù„ÉÉ„Éà:</span>
                <span class="status-value" id="spotNumber">1</span>
            </div>
            <div class="status-row">
                <span class="status-label">„Éà„É©„ÉÉ„ÇØ:</span>
                <span class="status-value" id="trackNumber">1 / ?</span>
            </div>
            <div class="status-row">
                <span class="status-label">ÂÆå‰∫Ü:</span>
                <span class="status-value" id="completedCount">0 / 6</span>
            </div>
            <div class="status-row">
                <span class="status-label">Áä∂ÊÖã:</span>
                <span class="status-value" id="statusText">ÂàùÊúüÂåñ‰∏≠...</span>
            </div>
            <div class="status-row" id="gpsStatusRow" style="display: none;">
                <span class="status-label">GPS:</span>
                <span class="status-value gps-status" id="gpsStatus">ÂèñÂæó‰∏≠...</span>
            </div>
            <div class="gps-distance" id="gpsDistance" style="display: none;">
                üìç Ê¨°„ÅÆ„Çπ„Éù„ÉÉ„Éà„Åæ„Åß: Ë®àÁÆó‰∏≠...
            </div>
        </div>

        <div class="volume-bar-container">
            <div class="volume-bar-label">Èü≥Èáè„É¨„Éô„É´</div>
            <div class="volume-bar-wrapper">
                <div class="volume-bar" id="volumeBar"></div>
                <div class="threshold-indicator" id="thresholdIndicator"></div>
                <span class="volume-value" id="volumeValue">0</span>
            </div>
        </div>

        <div class="control-section">
            <div class="control-label">
                <span>ÁÑ°Èü≥Ê§úÁü•„Åó„Åç„ÅÑÂÄ§</span>
                <span class="threshold-value" id="thresholdValue">50</span>
            </div>
            <input type="range" id="thresholdSlider" min="0" max="100" value="50" step="1">
        </div>

        <div class="control-section">
            <div class="control-label">
                <span>ÁÑ°Èü≥ÊåÅÁ∂öÊôÇÈñì</span>
                <span class="duration-value" id="durationValue">1.0Áßí</span>
            </div>
            <input type="range" id="durationSlider" min="0.5" max="30.0" value="1.0" step="0.5">
        </div>

        <div class="control-section">
            <div class="control-label">
                <span>GPSÊ§úÁü•ÁØÑÂõ≤</span>
                <span class="radius-value" id="radiusValue">100m</span>
            </div>
            <input type="range" id="radiusSlider" min="50" max="1000" value="100" step="50">
        </div>

        <div class="button-group">
            <div class="gps-toggle">
                <input type="checkbox" id="gpsToggle">
                <label for="gpsToggle">üìç GPSËá™ÂãïÂàá„ÇäÊõø„Åà</label>
            </div>
            <div class="notification-toggle">
                <input type="checkbox" id="notificationToggle" checked>
                <label for="notificationToggle">üîî ÈÄöÁü•Èü≥„ÇíÈ≥¥„Çâ„Åô</label>
            </div>
            <button class="btn-primary" id="toggleDetection" disabled>Ê§úÁü•ÈñãÂßã</button>
            <button class="btn-secondary" id="skipButton" disabled>Ê¨°„Å∏„Çπ„Ç≠„ÉÉ„Éó</button>
            <button class="btn-success" id="startButton">„Çπ„Çø„Éº„Éà</button>
        </div>
        
        <div class="loading" id="loadingMessage"></div>
    </div>

    <script>
        class AudioGuideSystem {
            constructor() {
                this.totalSpots = 6;
                this.currentSpot = 1;
                this.currentTrack = 1;
                this.spotTrackCounts = {};
                this.isDetecting = false;
                this.isPlaying = false;
                this.isLoading = false;
                this.silenceThreshold = 50;
                this.silenceDuration = 0;
                this.requiredSilenceDuration = 1000;
                this.audioContext = null;
                this.analyser = null;
                this.microphone = null;
                this.audioElement = new Audio();
                this.notificationAudio = new Audio();
                this.isSystemStarted = false;
                this.lastSoundTime = Date.now();
                this.useNotification = true;
                this.useGPS = false;
                this.gpsWatchId = null;
                this.currentPosition = null;
                this.lastSpotChangeByGPS = 0;
                this.gpsRadius = 100; // GPSÊ§úÁü•ÁØÑÂõ≤Ôºà„Éá„Éï„Ç©„É´„Éà100mÔºâ
                this.isFirstGPSFix = true; // ÂàùÂõûGPSÂèñÂæó„Éï„É©„Ç∞
                this.completedSpots = new Set(); // ÂÜçÁîüÂÆå‰∫Ü„Åó„Åü„Çπ„Éù„ÉÉ„Éà„ÇíË®òÈå≤
                
                // „Çπ„Éù„ÉÉ„Éà„ÅÆÂ∫ßÊ®ôË®≠ÂÆöÔºàÂÆüÈöõ„ÅÆÂ∫ßÊ®ô„Å´Â§âÊõ¥„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºâ
                this.spotLocations = [
                    { id: 1, lat: 35.6586, lon: 139.7454 }, // Êù±‰∫¨ÈßÖÔºà‰æãÔºâ
                    { id: 2, lat: 35.6762, lon: 139.6503 }, // Êù±‰∫¨„Çø„ÉØ„ÉºÔºà‰æãÔºâ
                    { id: 3, lat: 35.7148, lon: 139.7967 }, // „Çπ„Ç´„Ç§„ÉÑ„É™„ÉºÔºà‰æãÔºâ
                    { id: 4, lat: 35.6812, lon: 139.7671 }, // ÁßãËëâÂéüÔºà‰æãÔºâ
                    { id: 5, lat: 35.6895, lon: 139.6917 }, // Êñ∞ÂÆøÔºà‰æãÔºâ
                    { id: 6, lat: 35.60808686673842, lon: 139.55517818459722 }, // Êñ∞Ë¶è„Çπ„Éù„ÉÉ„Éà
                ];
                
                this.initUI();
                this.audioElement.addEventListener('ended', () => this.onAudioEnded());
                this.notificationAudio.addEventListener('ended', () => this.onNotificationEnded());
                this.loadSpotConfiguration();
            }

            async loadSpotConfiguration() {
                this.elements.loadingMessage.textContent = 'Èü≥Â£∞„Éï„Ç°„Ç§„É´„ÇíÊ§úÁ¥¢‰∏≠...';
                
                for (let spot = 1; spot <= this.totalSpots; spot++) {
                    let trackCount = 0;
                    let trackIndex = 1;
                    
                    while (trackIndex <= 20) {
                        const testPath = `/static/sounds/spot${spot}/${String(trackIndex).padStart(2, '0')}.wav`;
                        const exists = await this.checkFileExists(testPath);
                        
                        if (exists) {
                            trackCount = trackIndex;
                            trackIndex++;
                        } else {
                            break;
                        }
                    }
                    
                    this.spotTrackCounts[spot] = trackCount;
                    console.log(`Spot ${spot}: ${trackCount} tracks found`);
                }
                
                this.elements.loadingMessage.textContent = `Ë®≠ÂÆöÂÆå‰∫Ü: ÂÖ®${this.totalSpots}„Çπ„Éù„ÉÉ„Éà`;
                this.updateUI();
                
                setTimeout(() => {
                    this.elements.loadingMessage.textContent = '';
                }, 2000);
            }

            async checkFileExists(url) {
                try {
                    const response = await fetch(url, { method: 'HEAD' });
                    return response.ok;
                } catch (error) {
                    return false;
                }
            }

            initUI() {
                this.elements = {
                    spotNumber: document.getElementById('spotNumber'),
                    trackNumber: document.getElementById('trackNumber'),
                    completedCount: document.getElementById('completedCount'),
                    statusText: document.getElementById('statusText'),
                    volumeBar: document.getElementById('volumeBar'),
                    volumeValue: document.getElementById('volumeValue'),
                    thresholdSlider: document.getElementById('thresholdSlider'),
                    thresholdValue: document.getElementById('thresholdValue'),
                    durationSlider: document.getElementById('durationSlider'),
                    durationValue: document.getElementById('durationValue'),
                    radiusSlider: document.getElementById('radiusSlider'),
                    radiusValue: document.getElementById('radiusValue'),
                    thresholdIndicator: document.getElementById('thresholdIndicator'),
                    toggleDetection: document.getElementById('toggleDetection'),
                    skipButton: document.getElementById('skipButton'),
                    startButton: document.getElementById('startButton'),
                    loadingMessage: document.getElementById('loadingMessage'),
                    notificationToggle: document.getElementById('notificationToggle'),
                    gpsToggle: document.getElementById('gpsToggle'),
                    gpsStatusRow: document.getElementById('gpsStatusRow'),
                    gpsStatus: document.getElementById('gpsStatus'),
                    gpsDistance: document.getElementById('gpsDistance')
                };

                this.elements.thresholdSlider.addEventListener('input', (e) => {
                    this.silenceThreshold = parseInt(e.target.value);
                    this.elements.thresholdValue.textContent = this.silenceThreshold;
                    this.updateThresholdIndicator();
                });

                this.elements.durationSlider.addEventListener('input', (e) => {
                    const seconds = parseFloat(e.target.value);
                    this.requiredSilenceDuration = seconds * 1000;
                    this.elements.durationValue.textContent = `${seconds.toFixed(1)}Áßí`;
                });

                this.elements.radiusSlider.addEventListener('input', (e) => {
                    this.gpsRadius = parseInt(e.target.value);
                    this.elements.radiusValue.textContent = `${this.gpsRadius}m`;
                });

                this.elements.notificationToggle.addEventListener('change', (e) => {
                    this.useNotification = e.target.checked;
                });

                this.elements.gpsToggle.addEventListener('change', (e) => {
                    this.toggleGPS(e.target.checked);
                });

                this.elements.toggleDetection.addEventListener('click', () => {
                    this.toggleDetection();
                });

                this.elements.skipButton.addEventListener('click', () => {
                    this.skipToNextSpot();
                });

                this.elements.startButton.addEventListener('click', () => {
                    this.startSystem();
                });
            }

            toggleGPS(enabled) {
                this.useGPS = enabled;
                
                if (enabled) {
                    this.isFirstGPSFix = true; // GPS ON„Å´„Åó„ÅüÊôÇ„ÅØÂàùÂõûÊâ±„ÅÑ
                    this.startGPS();
                    this.elements.gpsStatusRow.style.display = 'flex';
                    this.elements.gpsDistance.style.display = 'block';
                } else {
                    this.stopGPS();
                    this.elements.gpsStatusRow.style.display = 'none';
                    this.elements.gpsDistance.style.display = 'none';
                }
            }

            startGPS() {
                if (!navigator.geolocation) {
                    alert('„Åä‰Ωø„ÅÑ„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØGPS„Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì');
                    this.elements.gpsToggle.checked = false;
                    return;
                }

                this.elements.gpsStatus.textContent = 'ÂèñÂæó‰∏≠...';
                
                this.gpsWatchId = navigator.geolocation.watchPosition(
                    (position) => this.onGPSSuccess(position),
                    (error) => this.onGPSError(error),
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 5000
                    }
                );
            }

            stopGPS() {
                if (this.gpsWatchId !== null) {
                    navigator.geolocation.clearWatch(this.gpsWatchId);
                    this.gpsWatchId = null;
                }
                this.currentPosition = null;
            }

            onGPSSuccess(position) {
                this.currentPosition = {
                    lat: position.coords.latitude,
                    lon: position.coords.longitude,
                    accuracy: position.coords.accuracy
                };

                this.elements.gpsStatus.textContent = `Á≤æÂ∫¶: ${Math.round(position.coords.accuracy)}m`;
                
                // ÊúÄ„ÇÇËøë„ÅÑ„Çπ„Éù„ÉÉ„Éà„ÇíÊ§úÁ¥¢
                let nearestSpot = null;
                let nearestDistance = Infinity;
                
                this.spotLocations.forEach(spot => {
                    const distance = this.calculateDistance(
                        this.currentPosition.lat,
                        this.currentPosition.lon,
                        spot.lat,
                        spot.lon
                    );
                    
                    if (distance < nearestDistance) {
                        nearestDistance = distance;
                        nearestSpot = spot;
                    }
                });

                // Ë∑ùÈõ¢Ë°®Á§∫„ÇíÊõ¥Êñ∞
                if (nearestSpot) {
                    if (nearestSpot.id === this.currentSpot) {
                        this.elements.gpsDistance.textContent = `üìç ÁèæÂú®„ÅÆ„Çπ„Éù„ÉÉ„ÉàÂÜÖ (${Math.round(nearestDistance)}m)`;
                    } else {
                        this.elements.gpsDistance.textContent = `üìç „Çπ„Éù„ÉÉ„Éà${nearestSpot.id}„Åæ„Åß: ${Math.round(nearestDistance)}m`;
                    }
                    
                    // ÂàùÂõûGPSÂèñÂæóÊôÇ„ÅØÁÑ°Êù°‰ª∂„ÅßÊúÄÂØÑ„Çä„Çπ„Éù„ÉÉ„Éà„Å´Âàá„ÇäÊõø„Åà
                    if (this.isFirstGPSFix && nearestDistance <= this.gpsRadius) {
                        this.changeSpotByGPS(nearestSpot.id);
                        this.isFirstGPSFix = false;
                        return;
                    }
                    
                    // 2ÂõûÁõÆ‰ª•ÈôçÔºöÁØÑÂõ≤ÂÜÖ„Å´ÂÖ•„Å£„Åü„ÇâËá™ÂãïÂàá„ÇäÊõø„ÅàÔºàÈÄ£Á∂öÂàá„ÇäÊõø„ÅàÈò≤Ê≠¢„ÅÇ„ÇäÔºâ
                    if (nearestDistance <= this.gpsRadius && nearestSpot.id !== this.currentSpot) {
                        const now = Date.now();
                        if (now - this.lastSpotChangeByGPS > 10000) {
                            this.changeSpotByGPS(nearestSpot.id);
                            this.lastSpotChangeByGPS = now;
                        }
                    }
                }
            }

            onGPSError(error) {
                console.error('GPS error:', error);
                let message = '„Ç®„É©„Éº';
                
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        message = '‰ΩçÁΩÆÊÉÖÂ†±„ÅåÊãíÂê¶„Åï„Çå„Åæ„Åó„Åü';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        message = '‰ΩçÁΩÆÊÉÖÂ†±„ÅåÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì';
                        break;
                    case error.TIMEOUT:
                        message = '„Çø„Ç§„É†„Ç¢„Ç¶„Éà';
                        break;
                }
                
                this.elements.gpsStatus.textContent = message;
            }

            calculateDistance(lat1, lon1, lat2, lon2) {
                // HaversineÂÖ¨Âºè„Åß2ÁÇπÈñì„ÅÆË∑ùÈõ¢„ÇíË®àÁÆóÔºà„É°„Éº„Éà„É´Ôºâ
                const R = 6371e3; // Âú∞ÁêÉ„ÅÆÂçäÂæÑÔºà„É°„Éº„Éà„É´Ôºâ
                const œÜ1 = lat1 * Math.PI / 180;
                const œÜ2 = lat2 * Math.PI / 180;
                const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
                const ŒîŒª = (lon2 - lon1) * Math.PI / 180;

                const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                        Math.cos(œÜ1) * Math.cos(œÜ2) *
                        Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

                return R * c;
            }

            changeSpotByGPS(newSpotId) {
                // Êó¢„Å´ÂÆå‰∫ÜÊ∏à„Åø„ÅÆ„Çπ„Éù„ÉÉ„Éà„ÅØ„Çπ„Ç≠„ÉÉ„Éó
                if (this.completedSpots.has(newSpotId)) {
                    console.log(`Spot ${newSpotId} already completed, skipping`);
                    this.elements.loadingMessage.textContent = `‚úì „Çπ„Éù„ÉÉ„Éà${newSpotId}„ÅØÂÜçÁîüÊ∏à„Åø„Åß„Åô`;
                    setTimeout(() => {
                        this.elements.loadingMessage.textContent = '';
                    }, 3000);
                    return;
                }
                
                if (this.isPlaying) {
                    this.audioElement.pause();
                    this.audioElement.currentTime = 0;
                }
                
                this.isPlaying = false;
                this.isLoading = false;
                this.currentSpot = newSpotId;
                this.currentTrack = 1;
                this.updateUI();
                
                this.elements.loadingMessage.textContent = `üìç „Çπ„Éù„ÉÉ„Éà${newSpotId}„Å´Âà∞ÁùÄÔºÅ`;
                setTimeout(() => {
                    this.elements.loadingMessage.textContent = '';
                }, 3000);
                
                if (this.isDetecting) {
                    this.updateStatus('Ê§úÁü•‰∏≠ (GPSÂàá„ÇäÊõø„Åà)');
                } else {
                    this.updateStatus('ÂæÖÊ©ü‰∏≠');
                }
                
                this.elements.skipButton.disabled = true;
            }

            async startSystem() {
                if (this.isSystemStarted) return;
                
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.analyser = this.audioContext.createAnalyser();
                    this.analyser.fftSize = 2048;
                    this.microphone = this.audioContext.createMediaStreamSource(stream);
                    this.microphone.connect(this.analyser);
                    
                    this.isSystemStarted = true;
                    this.elements.startButton.textContent = '„Ç∑„Çπ„ÉÜ„É†Ëµ∑Âãï‰∏≠';
                    this.elements.startButton.disabled = true;
                    this.elements.toggleDetection.disabled = false;
                    
                    this.updateStatus('ÂæÖÊ©ü‰∏≠');
                    this.startVolumeMonitoring();
                    this.updateThresholdIndicator();
                    
                    this.toggleDetection();
                    
                } catch (error) {
                    alert('„Éû„Ç§„ÇØ„Å∏„ÅÆ„Ç¢„ÇØ„Çª„Çπ„ÅåÊãíÂê¶„Åï„Çå„Åæ„Åó„Åü„ÄÇ„Éñ„É©„Ç¶„Ç∂„ÅÆË®≠ÂÆö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    console.error('Microphone access error:', error);
                }
            }

            startVolumeMonitoring() {
                const updateVolume = () => {
                    if (!this.analyser) return;
                    
                    const bufferLength = this.analyser.frequencyBinCount;
                    const dataArray = new Uint8Array(bufferLength);
                    const frequencyData = new Uint8Array(bufferLength);
                    
                    this.analyser.getByteTimeDomainData(dataArray);
                    this.analyser.getByteFrequencyData(frequencyData);
                    
                    const sampleRate = this.audioContext.sampleRate;
                    const nyquist = sampleRate / 2;
                    const frequencyPerBin = nyquist / bufferLength;
                    
                    const voiceMinFreq = 300;
                    const voiceMaxFreq = 3400;
                    
                    const minBin = Math.floor(voiceMinFreq / frequencyPerBin);
                    const maxBin = Math.floor(voiceMaxFreq / frequencyPerBin);
                    
                    let voiceSum = 0;
                    let voiceCount = 0;
                    for (let i = minBin; i < maxBin && i < frequencyData.length; i++) {
                        voiceSum += frequencyData[i];
                        voiceCount++;
                    }
                    const voiceAverage = voiceCount > 0 ? voiceSum / voiceCount : 0;
                    
                    const normalizedVolume = Math.min(100, Math.max(0, (voiceAverage / 255) * 100));
                    
                    this.elements.volumeBar.style.width = normalizedVolume + '%';
                    this.elements.volumeValue.textContent = Math.round(normalizedVolume);
                    
                    if (this.isDetecting && !this.isPlaying && !this.isLoading) {
                        const currentTime = Date.now();
                        
                        if (normalizedVolume > this.silenceThreshold) {
                            this.lastSoundTime = currentTime;
                            this.silenceDuration = 0;
                        } else {
                            this.silenceDuration = currentTime - this.lastSoundTime;
                            
                            if (this.silenceDuration >= this.requiredSilenceDuration) {
                                this.onSilenceDetected();
                            }
                        }
                    }
                    
                    requestAnimationFrame(updateVolume);
                };
                
                updateVolume();
            }

            updateThresholdIndicator() {
                this.elements.thresholdIndicator.style.left = this.silenceThreshold + '%';
            }

            toggleDetection() {
                if (!this.isSystemStarted) return;
                
                this.isDetecting = !this.isDetecting;
                
                if (this.isDetecting) {
                    this.elements.toggleDetection.textContent = 'Ê§úÁü•ÂÅúÊ≠¢';
                    this.elements.toggleDetection.classList.remove('btn-primary');
                    this.elements.toggleDetection.classList.add('btn-danger');
                    this.lastSoundTime = Date.now();
                    this.silenceDuration = 0;
                    
                    if (!this.isPlaying) {
                        this.updateStatus('Ê§úÁü•‰∏≠');
                    }
                } else {
                    this.elements.toggleDetection.textContent = 'Ê§úÁü•ÈñãÂßã';
                    this.elements.toggleDetection.classList.remove('btn-danger');
                    this.elements.toggleDetection.classList.add('btn-primary');
                    this.updateStatus('Ê§úÁü•ÂÅúÊ≠¢');
                }
            }

            onSilenceDetected() {
                if (this.isPlaying || this.isLoading) return;
                
                // ÂÆå‰∫ÜÊ∏à„Åø„Çπ„Éù„ÉÉ„Éà„ÅØ„Çπ„Ç≠„ÉÉ„Éó
                if (this.completedSpots.has(this.currentSpot)) {
                    console.log(`Spot ${this.currentSpot} already completed, skipping`);
                    return;
                }
                
                const totalTracks = this.spotTrackCounts[this.currentSpot] || 0;
                
                if (totalTracks === 0) {
                    console.log(`Spot ${this.currentSpot} has no tracks, moving to next spot`);
                    this.moveToNextSpot();
                    return;
                }
                
                if (this.currentTrack <= totalTracks) {
                    this.playCurrentTrack();
                }
                
                this.silenceDuration = 0;
                this.lastSoundTime = Date.now();
            }

            playCurrentTrack() {
                if (this.isPlaying || this.isLoading) return;
                
                this.isLoading = true;
                this.isPlaying = true;
                this.elements.skipButton.disabled = false;
                
                if (this.useNotification) {
                    this.updateStatus('ÈÄöÁü•Èü≥ÂÜçÁîü‰∏≠...');
                    this.notificationAudio.src = '/static/sounds/notification.wav';
                    this.notificationAudio.load();
                    
                    this.notificationAudio.play()
                        .then(() => {
                            console.log('Notification sound playing');
                        })
                        .catch(error => {
                            console.error('Notification play error:', error);
                            this.playMainAudio();
                        });
                } else {
                    this.playMainAudio();
                }
            }

            onNotificationEnded() {
                this.playMainAudio();
            }

            playMainAudio() {
                const audioPath = `/static/sounds/spot${this.currentSpot}/${String(this.currentTrack).padStart(2, '0')}.wav`;
                
                this.updateStatus('Ë™≠„ÅøËæº„Åø‰∏≠...');
                
                this.audioElement.src = audioPath;
                this.audioElement.load();
                
                this.audioElement.play()
                    .then(() => {
                        this.isLoading = false;
                        this.updateStatus('ÂÜçÁîü‰∏≠');
                        console.log(`Playing: ${audioPath}`);
                    })
                    .catch(error => {
                        console.error('Audio play error:', error);
                        console.error('Failed to load:', audioPath);
                        this.isLoading = false;
                        this.isPlaying = false;
                        this.updateStatus('„Ç®„É©„Éº: Èü≥Â£∞„Éï„Ç°„Ç§„É´„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                        this.elements.skipButton.disabled = true;
                        
                        setTimeout(() => {
                            this.handlePlaybackError();
                        }, 2000);
                    });
            }

            handlePlaybackError() {
                const totalTracks = this.spotTrackCounts[this.currentSpot] || 0;
                
                if (this.currentTrack < totalTracks) {
                    this.currentTrack++;
                    this.updateUI();
                    this.silenceDuration = 0;
                    this.lastSoundTime = Date.now();
                    if (this.isDetecting) {
                        this.updateStatus('Ê§úÁü•‰∏≠ („Ç®„É©„ÉºÂæå)');
                    }
                } else {
                    this.moveToNextSpot();
                }
            }

            onAudioEnded() {
                this.isPlaying = false;
                this.isLoading = false;
                this.lastSoundTime = Date.now();
                this.silenceDuration = 0;
                this.elements.skipButton.disabled = true;
                
                const totalTracks = this.spotTrackCounts[this.currentSpot] || 0;
                
                if (this.currentTrack < totalTracks) {
                    this.currentTrack++;
                    this.updateUI();
                    
                    if (this.isDetecting) {
                        this.updateStatus('Ê§úÁü•‰∏≠ (Ê¨°„ÅÆ„Éà„É©„ÉÉ„ÇØÂæÖÊ©ü)');
                    } else {
                        this.updateStatus('ÂæÖÊ©ü‰∏≠');
                    }
                } else {
                    // ÁèæÂú®„ÅÆ„Çπ„Éù„ÉÉ„Éà„ÅÆÂÖ®„Éà„É©„ÉÉ„ÇØÂÜçÁîüÂÆå‰∫Ü
                    this.completedSpots.add(this.currentSpot);
                    this.updateCompletedCount();
                    
                    console.log(`Spot ${this.currentSpot} completed`);
                    
                    // GPS„É¢„Éº„Éâ„Åß„ÅØÊ¨°„ÅÆ„Çπ„Éù„ÉÉ„Éà„Å´Ëá™Âãï„ÅßÁßªÂãï„Åó„Å™„ÅÑ
                    if (!this.useGPS) {
                        this.moveToNextSpot();
                    } else {
                        // GPS„É¢„Éº„Éâ„Åß„ÅØÁèæÂú®„ÅÆ„Çπ„Éù„ÉÉ„Éà„Å´Áïô„Åæ„Çã
                        this.currentTrack = 1;
                        this.updateUI();
                        if (this.isDetecting) {
                            this.updateStatus('Ê§úÁü•‰∏≠ („Çπ„Éù„ÉÉ„ÉàÂÆå‰∫Ü)');
                        } else {
                            this.updateStatus('„Çπ„Éù„ÉÉ„ÉàÂÆå‰∫Ü');
                        }
                    }
                }
            }

            moveToNextSpot() {
                this.currentSpot++;
                this.currentTrack = 1;
                
                if (this.currentSpot > this.totalSpots) {
                    this.speakFinalMessage();
                    this.currentSpot = 1;
                }
                
                this.updateUI();
                
                if (this.isDetecting) {
                    this.updateStatus('Ê§úÁü•‰∏≠ (Ê¨°„ÅÆ„Çπ„Éù„ÉÉ„Éà)');
                } else {
                    this.updateStatus('ÂæÖÊ©ü‰∏≠');
                }
                
                this.elements.skipButton.disabled = true;
            }

            skipToNextSpot() {
                if (this.isPlaying) {
                    this.audioElement.pause();
                    this.audioElement.currentTime = 0;
                }
                
                this.isPlaying = false;
                this.isLoading = false;
                this.moveToNextSpot();
            }

            speakFinalMessage() {
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance('„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åó„Åü„ÄÇ„ÉÑ„Ç¢„Éº„ÅØÁµÇ‰∫Ü„Åß„Åô„ÄÇ');
                    utterance.lang = 'ja-JP';
                    utterance.rate = 1.0;
                    window.speechSynthesis.speak(utterance);
                }
            }

            updateUI() {
                const totalTracks = this.spotTrackCounts[this.currentSpot] || '?';
                this.elements.spotNumber.textContent = this.currentSpot;
                this.elements.trackNumber.textContent = `${this.currentTrack} / ${totalTracks}`;
            }

            updateCompletedCount() {
                this.elements.completedCount.textContent = `${this.completedSpots.size} / ${this.totalSpots}`;
            }

            updateStatus(status) {
                this.elements.statusText.textContent = status;
                this.elements.statusText.className = 'status-value';
                
                if (status.includes('Ê§úÁü•‰∏≠')) {
                    this.elements.statusText.classList.add('status-active', 'pulse');
                } else if (status.includes('ÂÜçÁîü‰∏≠')) {
                    this.elements.statusText.classList.add('status-playing');
                } else {
                    this.elements.statusText.classList.remove('pulse');
                }
            }
        }

        // „Ç∑„Çπ„ÉÜ„É†„ÅÆÂàùÊúüÂåñ
        const guideSystem = new AudioGuideSystem();
    </script>
</body>
</html>