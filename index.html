<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÊóÖ„Å®„ÇÇ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
            font-size: 24px;
        }

        .status-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .status-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .status-row:last-child {
            margin-bottom: 0;
        }

        .status-label {
            color: #6c757d;
            font-weight: 600;
        }

        .status-value {
            color: #212529;
            font-weight: 700;
        }

        .status-active {
            color: #28a745;
        }

        .status-playing {
            color: #007bff;
        }

        .gps-status {
            color: #17a2b8;
        }

        .gps-distance {
            background: #e7f5ff;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            margin-top: 10px;
            font-size: 16px;
            font-weight: 700;
            color: #0c5460;
        }

        .volume-bar-container {
            margin-bottom: 25px;
        }

        .volume-bar-label {
            font-size: 14px;
            color: #6c757d;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .volume-bar-wrapper {
            background: #e9ecef;
            height: 30px;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .volume-bar {
            height: 100%;
            background: linear-gradient(90deg, #28a745 0%, #ffc107 50%, #dc3545 100%);
            width: 0%;
            transition: width 0.1s ease-out;
        }

        .threshold-indicator {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 3px;
            background: #dc3545;
            z-index: 10;
            transition: left 0.3s ease;
        }

        .threshold-indicator::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 10px;
            height: 10px;
            background: #dc3545;
            border-radius: 50%;
            border: 2px solid white;
        }

        .volume-value {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            font-weight: 700;
            color: #495057;
            z-index: 5;
        }

        .control-section {
            margin-bottom: 15px;
        }

        .control-label {
            font-size: 14px;
            color: #6c757d;
            margin-bottom: 10px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .threshold-value {
            color: #667eea;
            font-weight: 700;
        }

        .duration-value {
            color: #764ba2;
            font-weight: 700;
        }

        .radius-value {
            color: #17a2b8;
            font-weight: 700;
        }

        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #e9ecef;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }

        .notification-toggle, .gps-toggle {
            grid-column: 1 / -1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .notification-toggle input[type="checkbox"],
        .gps-toggle input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .notification-toggle label,
        .gps-toggle label {
            font-size: 14px;
            font-weight: 600;
            color: #495057;
            cursor: pointer;
        }

        button {
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.4);
        }

        .btn-success {
            background: #28a745;
            color: white;
            grid-column: 1 / -1;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.6;
            }
        }

        .loading {
            text-align: center;
            color: #667eea;
            font-size: 14px;
            margin-top: 10px;
        }

        @media (max-width: 480px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 20px;
                margin-bottom: 20px;
            }

            button {
                padding: 12px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéß ÊóÖ„Å®„ÇÇ</h1>
        
        <div class="status-section">
            <div class="status-row">
                <span class="status-label">„Çπ„Éù„ÉÉ„Éà:</span>
                <span class="status-value" id="spotNumber">1</span>
            </div>
            <div class="status-row">
                <span class="status-label">„Éà„É©„ÉÉ„ÇØ:</span>
                <span class="status-value" id="trackNumber">1 / ?</span>
            </div>
            <div class="status-row">
                <span class="status-label">Áä∂ÊÖã:</span>
                <span class="status-value" id="statusText">ÂàùÊúüÂåñ‰∏≠...</span>
            </div>
            <div class="status-row" id="gpsStatusRow" style="display: none;">
                <span class="status-label">GPS:</span>
                <span class="status-value gps-status" id="gpsStatus">ÂèñÂæó‰∏≠...</span>
            </div>
            <div class="gps-distance" id="gpsDistance" style="display: none;">
                üìç Ê¨°„ÅÆ„Çπ„Éù„ÉÉ„Éà„Åæ„Åß: Ë®àÁÆó‰∏≠...
            </div>
        </div>

        <div class="volume-bar-container">
            <div class="volume-bar-label">Èü≥Èáè„É¨„Éô„É´</div>
            <div class="volume-bar-wrapper">
                <div class="volume-bar" id="volumeBar"></div>
                <div class="threshold-indicator" id="thresholdIndicator"></div>
                <span class="volume-value" id="volumeValue">0</span>
            </div>
        </div>

        <div class="control-section">
            <div class="control-label">
                <span>ÁÑ°Èü≥Ê§úÁü•„Åó„Åç„ÅÑÂÄ§</span>
                <span class="threshold-value" id="thresholdValue">15</span>
            </div>
            <input type="range" id="thresholdSlider" min="0" max="100" value="15" step="1">
        </div>

        <div class="control-section">
            <div class="control-label">
                <span>ÁÑ°Èü≥ÊåÅÁ∂öÊôÇÈñì</span>
                <span class="duration-value" id="durationValue">10.0Áßí</span>
            </div>
            <input type="range" id="durationSlider" min="0.5" max="30.0" value="10.0" step="0.5">
        </div>

        <div class="control-section">
            <div class="control-label">
                <span>GPSÊ§úÁü•ÁØÑÂõ≤</span>
                <span class="radius-value" id="radiusValue">100m</span>
            </div>
            <input type="range" id="radiusSlider" min="50" max="1000" value="100" step="50">
        </div>

        <div class="button-group">
            <div class="gps-toggle">
                <input type="checkbox" id="gpsToggle">
                <label for="gpsToggle">üìç GPSËá™ÂãïÂàá„ÇäÊõø„Åà</label>
            </div>
            <div class="notification-toggle">
                <input type="checkbox" id="notificationToggle" checked>
                <label for="notificationToggle">üîî ÈÄöÁü•Èü≥„ÇíÈ≥¥„Çâ„Åô</label>
            </div>
            <button class="btn-primary" id="toggleDetection" disabled>Ê§úÁü•ÈñãÂßã</button>
            <button class="btn-secondary" id="skipButton" disabled>Ê¨°„Å∏„Çπ„Ç≠„ÉÉ„Éó</button>
            <button class="btn-success" id="startButton">„Çπ„Çø„Éº„Éà</button>
        </div>
        
        <div class="loading" id="loadingMessage"></div>
    </div>

 <script>
const BASE_PATH = window.location.pathname.startsWith("/tabitomo") ? "/tabitomo" : "";
const BASE_URL = window.location.origin + BASE_PATH;

class AudioGuideSystem {
    constructor() {
        this.totalSpots = 6;
        this.currentSpot = 1;
        this.currentTrack = 1;
        this.spotTrackCounts = {};
        this.isDetecting = false;
        this.isPlaying = false;
        this.isLoading = false;
        this.silenceThreshold = 15;
        this.silenceDuration = 0;
        this.requiredSilenceDuration = 10000;
        this.audioContext = null;
        this.analyser = null;
        this.microphone = null;
        this.audioElement = new Audio();
        this.notificationAudio = new Audio();
        this.isSystemStarted = false;
        this.lastSoundTime = Date.now();
        this.useNotification = true;
        this.useGPS = false;
        this.gpsWatchId = null;
        this.currentPosition = null;
        this.lastSpotChangeByGPS = 0;
        this.gpsRadius = 100;
        this.isFirstGPSFix = true;

        this.initUI();
        this.audioElement.addEventListener("ended", () => this.onAudioEnded());
        this.notificationAudio.addEventListener("ended", () => this.onNotificationEnded());
        this.loadSpotConfiguration();
    }

    async loadSpotConfiguration() {
        this.elements.loadingMessage.textContent = "Èü≥Â£∞„Éï„Ç°„Ç§„É´„ÇíÊ§úÁ¥¢‰∏≠...";

        for (let spot = 1; spot <= this.totalSpots; spot++) {
            let trackCount = 0;
            let trackIndex = 1;

            while (trackIndex <= 20) {
                const testPath = `${BASE_URL}/static/sounds/spot${spot}/${String(trackIndex).padStart(2, "0")}.wav`;
                const exists = await this.checkFileExists(testPath);
                if (exists) {
                    trackCount = trackIndex;
                    trackIndex++;
                } else {
                    break;
                }
            }

            this.spotTrackCounts[spot] = trackCount;
            console.log(`Spot ${spot}: ${trackCount} tracks found`);
        }

        this.updateUI();
        this.elements.loadingMessage.textContent = `Ë®≠ÂÆöÂÆå‰∫Ü: ÂÖ®${this.totalSpots}„Çπ„Éù„ÉÉ„Éà`;
        setTimeout(() => {
            this.elements.loadingMessage.textContent = "";
        }, 2000);
    }

    async checkFileExists(url) {
        try {
            const res = await fetch(url, { method: "HEAD" });
            return res.ok;
        } catch (e) {
            return false;
        }
    }

    initUI() {
        this.elements = {
            spotNumber: document.getElementById("spotNumber"),
            trackNumber: document.getElementById("trackNumber"),
            statusText: document.getElementById("statusText"),
            volumeBar: document.getElementById("volumeBar"),
            volumeValue: document.getElementById("volumeValue"),
            thresholdSlider: document.getElementById("thresholdSlider"),
            thresholdValue: document.getElementById("thresholdValue"),
            durationSlider: document.getElementById("durationSlider"),
            durationValue: document.getElementById("durationValue"),
            radiusSlider: document.getElementById("radiusSlider"),
            radiusValue: document.getElementById("radiusValue"),
            thresholdIndicator: document.getElementById("thresholdIndicator"),
            toggleDetection: document.getElementById("toggleDetection"),
            skipButton: document.getElementById("skipButton"),
            startButton: document.getElementById("startButton"),
            loadingMessage: document.getElementById("loadingMessage"),
            notificationToggle: document.getElementById("notificationToggle"),
            gpsToggle: document.getElementById("gpsToggle"),
        };

        this.elements.thresholdSlider.addEventListener("input", (e) => {
            this.silenceThreshold = parseInt(e.target.value);
            this.elements.thresholdValue.textContent = this.silenceThreshold;
            this.updateThresholdIndicator();
        });

        this.elements.durationSlider.addEventListener("input", (e) => {
            const sec = parseFloat(e.target.value);
            this.requiredSilenceDuration = sec * 1000;
            this.elements.durationValue.textContent = `${sec.toFixed(1)}Áßí`;
        });

        this.elements.toggleDetection.addEventListener("click", () => this.toggleDetection());
        this.elements.startButton.addEventListener("click", () => this.startSystem());
        this.elements.skipButton.addEventListener("click", () => this.skipToNextSpot());
        this.elements.notificationToggle.addEventListener("change", (e) => (this.useNotification = e.target.checked));
    }

    async startSystem() {
        if (this.isSystemStarted) return;

        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
            this.analyser = this.audioContext.createAnalyser();
            this.analyser.fftSize = 2048;
            this.microphone = this.audioContext.createMediaStreamSource(stream);
            this.microphone.connect(this.analyser);

            this.isSystemStarted = true;
            this.elements.startButton.disabled = true;
            this.elements.toggleDetection.disabled = false;

            this.updateStatus("ÂæÖÊ©ü‰∏≠");
            this.startVolumeMonitoring();
            this.updateThresholdIndicator();
            this.toggleDetection();
        } catch (err) {
            alert("„Éû„Ç§„ÇØ„ÅÆ‰ΩøÁî®„ÅåÊãíÂê¶„Åï„Çå„Åæ„Åó„ÅüÔºÅ");
        }
    }

    startVolumeMonitoring() {
        const update = () => {
            if (!this.analyser) return;

            const bufferLength = this.analyser.frequencyBinCount;
            const data = new Uint8Array(bufferLength);
            this.analyser.getByteFrequencyData(data);

            const avg = data.reduce((a, b) => a + b, 0) / data.length;
            const volume = Math.min(100, Math.max(0, (avg / 255) * 100));

            this.elements.volumeBar.style.width = volume + "%";
            this.elements.volumeValue.textContent = Math.round(volume);

            if (this.isDetecting && !this.isPlaying && !this.isLoading) {
                const now = Date.now();
                if (volume > this.silenceThreshold) {
                    this.lastSoundTime = now;
                } else {
                    if (now - this.lastSoundTime >= this.requiredSilenceDuration) {
                        this.onSilenceDetected();
                    }
                }
            }

            requestAnimationFrame(update);
        };

        update();
    }

    updateThresholdIndicator() {
        this.elements.thresholdIndicator.style.left = this.silenceThreshold + "%";
    }

    toggleDetection() {
        this.isDetecting = !this.isDetecting;

        if (this.isDetecting) {
            this.elements.toggleDetection.textContent = "Ê§úÁü•ÂÅúÊ≠¢";
            this.updateStatus("Ê§úÁü•‰∏≠");
            this.lastSoundTime = Date.now();
        } else {
            this.elements.toggleDetection.textContent = "Ê§úÁü•ÈñãÂßã";
            this.updateStatus("Ê§úÁü•ÂÅúÊ≠¢");
        }
    }

    onSilenceDetected() {
        if (this.isPlaying || this.isLoading) return;

        const total = this.spotTrackCounts[this.currentSpot] || 0;

        if (this.currentTrack <= total) {
            this.playCurrentTrack();
        } else {
            this.moveToNextSpot();
        }
    }

    playCurrentTrack() {
        this.isLoading = true;
        this.isPlaying = true;
        this.elements.skipButton.disabled = false;

        if (this.useNotification) {
            this.notificationAudio.src = `${BASE_URL}/static/sounds/notification.wav`;
            this.notificationAudio.play().catch(() => this.playMainAudio());
        } else {
            this.playMainAudio();
        }
    }

    onNotificationEnded() {
        this.playMainAudio();
    }

    playMainAudio() {
        const url = `${BASE_URL}/static/sounds/spot${this.currentSpot}/${String(this.currentTrack).padStart(2, "0")}.wav`;

        this.updateStatus("Ë™≠„ÅøËæº„Åø‰∏≠...");
        this.audioElement.src = url;
        this.audioElement.load();

        this.audioElement.play()
            .then(() => {
                this.updateStatus("ÂÜçÁîü‰∏≠");
                this.isLoading = false;
            })
            .catch(() => {
                this.updateStatus("„Ç®„É©„Éº: Èü≥Â£∞„Å™„Åó");
                this.isPlaying = false;
                this.isLoading = false;
                this.skipToNextSpot();
            });
    }

    onAudioEnded() {
        this.isPlaying = false;
        this.currentTrack++;

        const total = this.spotTrackCounts[this.currentSpot];

        if (this.currentTrack <= total) {
            this.updateUI();
            this.updateStatus("Ê§úÁü•‰∏≠(Ê¨°„ÅÆ„Éà„É©„ÉÉ„ÇØ)");
        } else {
            this.moveToNextSpot();
        }
    }

    moveToNextSpot() {
        this.currentSpot++;
        if (this.currentSpot > this.totalSpots) this.currentSpot = 1;

        this.currentTrack = 1;
        this.updateUI();
        this.updateStatus("Ê§úÁü•‰∏≠(Ê¨°„ÅÆ„Çπ„Éù„ÉÉ„Éà)");
        this.elements.skipButton.disabled = true;
    }

    skipToNextSpot() {
        if (this.isPlaying) {
            this.audioElement.pause();
            this.audioElement.currentTime = 0;
        }
        this.moveToNextSpot();
    }

    updateUI() {
        const total = this.spotTrackCounts[this.currentSpot] || "?";
        this.elements.spotNumber.textContent = this.currentSpot;
        this.elements.trackNumber.textContent = `${this.currentTrack} / ${total}`;
    }

    updateStatus(msg) {
        this.elements.statusText.textContent = msg;
    }
}

const guideSystem = new AudioGuideSystem();
</script>
</body>
</html>